<app-navbar></app-navbar>

<div class="page-container" style="display: flex; flex-direction: column">
  <section class="acoes-topo" style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center; justify-content: space-between;">
    <div>
      <button class="btn btn-sec " (click)="voltar()" title="Voltar">
        <i class="pi pi-arrow-left"></i> Voltar
      </button>
    </div>
  </section>

  <div class="container">
    <h1>Otimiza√ß√£o do Carregamento</h1>

<!-- Etapa 1: Caminh√µes -->
<div *ngIf="etapaAtual === 'caminhao'">
  <h3><i class="pi pi-truck"></i> Escolha um Caminh√£o</h3>

  <!-- üîé Filtro -->
  <div class="filtro-bar">
    <input
      type="text"
      [(ngModel)]="filtroCaminhao"
      placeholder="Filtrar caminh√µes por nome, peso ou dimens√µes..."
      class="input-filtro"
    />
    <button type="button" class="btn-secundario" (click)="filtroCaminhao = ''">
      Limpar
    </button>
  </div>

  <!-- ‚úÖ Listagem em Cards -->
  <div class="card-grid">
    <div
      class="card"
      *ngFor="let caminhao of caminhoesFiltrados"
      [class.ativo]="caminhaoSelecionado?.id === caminhao.id"
      (click)="selecionarCaminhao(caminhao)"
      style="cursor: pointer;"
    >
      <h3><i class="pi pi-truck"></i> {{ caminhao.nome }}</h3>

      <ul class="card-info">
        <li><strong>Dimens√µes:</strong> {{ caminhao.comprimento }}m √ó {{ caminhao.largura }}m √ó {{ caminhao.altura }}m</li>
        <li><strong>Peso M√°ximo:</strong> {{ caminhao.pesoLimite / 1000 }}t</li>
      </ul>
    </div>
  </div>

  <!-- üîò Bot√£o de confirma√ß√£o -->
  <div class="confirmacao-box" style="margin-top: 20px; text-align: center;">
    <p *ngIf="!caminhaoSelecionado">Selecione um caminh√£o para continuar</p>
    <button
      class="btn-continuar"
      [disabled]="!caminhaoSelecionado"
      (click)="continuarParaPacotes()"
    >
      Continuar
    </button>
  </div>
</div>



 <!-- Etapa 2: Pacotes -->
<div *ngIf="etapaAtual === 'pacotes'">
  <h3><i class="pi pi-box"></i> Escolha os Pacotes</h3>
  <p class="contador-produtos">
    Pacotes selecionados: {{ pacotesSelecionados.length }}
  </p>

  <!-- Novo Pedido -->
  <div *ngIf="!pedidoAtual">
    <button (click)="criarNovoPedido()" class="button btn-sucesso">
      + Novo Pedido
    </button>
  </div>

  <!-- Pedido Atual -->
  <div *ngIf="pedidoAtual">
    <h4>Pedido: {{ pedidoAtual.nome }}</h4>

    <!-- Filtro -->
    <div class="filtro-bar">
      <input
        type="text"
        [(ngModel)]="filtroPacote"
        placeholder="Filtrar pacotes por nome, peso ou dimens√µes..."
        class="input-filtro"
      />
      <button type="button" class="btn btn-secundario" (click)="filtroPacote = ''">
        Limpar
      </button>
    </div>

    <!-- Cards de Pacotes -->
    <div class="card-grid">
      <div
        class="card"
        *ngFor="let pacote of pacotesFiltrados"
        [class.ativo]="pacotesSelecionados.includes(pacote)"
        (click)="togglePacote(pacote)"
      >
        <div class="card-header">
          <i class="pi pi-box"></i>
          <span class="card-title">{{ pacote.nome }}</span>
        </div>

        <div class="card-body">
          <p><strong>Dimens√µes:</strong> {{ pacote.comprimento }}m √ó {{ pacote.largura }}m √ó {{ pacote.altura }}m</p>
          <p><strong>Peso:</strong> {{ pacote.peso }}kg</p>
          <p>
            <strong>Rotaciona:</strong>
            <span [ngClass]="{ 'rotaca-true': pacote.rotacao, 'rotaca-false': !pacote.rotacao }">
              {{ pacote.rotacao ? 'Sim' : 'N√£o' }}
            </span>
          </p>
        </div>

        <!-- Quantidade + A√ß√µes -->
        <div class="card-actions" *ngIf="pacotesSelecionados.includes(pacote) && pacote.id !== undefined">
          <input
            type="number"
            min="1"
            [(ngModel)]="quantidadesSelecionadas[pacote.id!]"
            [disabled]="quantidadesConfirmadas[pacote.id!]"
            (click)="$event.stopPropagation()"
            (keydown)="$event.stopPropagation()"
          />

          <ng-container *ngIf="!quantidadesConfirmadas[pacote.id!]">
            <button class="btn-ok"
              type="button"
              (click)="confirmarQuantidade(pacote); $event.stopPropagation()">
              OK
            </button>
          </ng-container>

          <ng-container *ngIf="quantidadesConfirmadas[pacote.id!]">
            <button class="btn-desfazer"
              type="button"
              (click)="desfazerConfirmacao(pacote); $event.stopPropagation()">
              Desfazer
            </button>
          </ng-container>

          <button class="btn-cancelar"
            type="button"
            (click)="cancelarSelecao(pacote); $event.stopPropagation()">
            Cancelar
          </button>
        </div>
      </div>
    </div>

    <!-- Confirma√ß√£o -->
    <div class="confirmacao-box" style="margin-top: 20px; text-align: center;">
      <p *ngIf="pacotesSelecionados.length === 0">Selecione ao menos um pacote para este pedido</p>
      <button class="btn-continuar"
              [disabled]="pacotesSelecionados.length === 0 || !todosPacotesConfirmados()"
              (click)="confirmarPedido()">
        Confirmar Pedido
      </button>
    </div>
  </div>

  <!-- Lista de Pedidos -->
  <div *ngIf="pedidos.length > 0" class="lista-pedidos-container">
    <h4>üì¶ Pedidos adicionados ao caminh√£o:</h4>
    <ul class="lista-pedidos">
      <li *ngFor="let pedido of pedidos" class="pedido-item">
        <div class="pedido-info">
          <span class="pedido-nome">{{ pedido.nome }}</span>
          <span class="pedido-detalhes">{{ pedido.pacotes.length }} tipo(s) de pacote</span>
        </div>
      </li>
    </ul>
  </div>

  <!-- Confirma√ß√£o Final -->
  <div class="confirmacao-box" style="margin-top: 20px; text-align: center;">
    <p *ngIf="pacotesSelecionados.length === 0">Selecione pelo menos um pacote</p>
    <button class="btn-continuar"
            [disabled]="pacotesSelecionados.length === 0 || !todosPacotesConfirmados()"
            (click)="confirmarOtimizacao()">
      Confirmar Otimiza√ß√£o
    </button>
  </div>
</div>

</div>

<app-screen-background></app-screen-background>
<app-popup></app-popup>
